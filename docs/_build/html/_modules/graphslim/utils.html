<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>graphslim.utils &mdash; GraphSlim documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1"/>
    <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094"/>


    <!--[if lt IE 9]>
      <script src="../../_static/js/html5shiv.min.js"></script>
    <![endif]-->

    <script src="../../_static/jquery.js?v=5d32c60e"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
    <script data-url_root="../../" id="documentation_options"
            src="../../_static/documentation_options.js?v=b3ba4146"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html"/>
    <link rel="search" title="Search" href="../../search.html"/>
</head>

<body class="wy-body-for-nav">
<div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
        <div class="wy-side-scroll">
            <div class="wy-side-nav-search">


                <a href="../../index.html" class="icon icon-home">
                    GraphSlim
                </a>
                <div role="search">
                    <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
                        <input type="text" name="q" placeholder="Search docs" aria-label="Search docs"/>
                        <input type="hidden" name="check_keywords" value="yes"/>
                        <input type="hidden" name="area" value="default"/>
                    </form>
                </div>
            </div>
            <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
                <p class="caption" role="heading"><span class="caption-text">Installation</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a>
                    </li>
                </ul>
                <p class="caption" role="heading"><span class="caption-text">Quickstart</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../quickstart.html">Quick Start</a>
                    </li>
                </ul>
                <p class="caption" role="heading"><span class="caption-text">Dataset</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../source/graphslim.dataset.html">graphslim.dataset
                        package</a></li>
                </ul>
                <p class="caption" role="heading"><span class="caption-text">Model</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../source/graphslim.models.html">graphslim.models
                        package</a></li>
                </ul>
                <p class="caption" role="heading"><span class="caption-text">Method</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../source/graphslim.coarsening.html">graphslim.coarsening
                        package</a></li>
                    <li class="toctree-l1"><a class="reference internal"
                                              href="../../source/graphslim.condensation.html">graphslim.condensation
                        package</a></li>
                    <li class="toctree-l1"><a class="reference internal"
                                              href="../../source/graphslim.sparsification.html">graphslim.sparsification
                        package</a></li>
                </ul>
                <p class="caption" role="heading"><span class="caption-text">Evaluation</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../source/graphslim.evaluation.html">graphslim.evaluation
                        package</a></li>
                </ul>

            </div>
        </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
        <nav class="wy-nav-top" aria-label="Mobile navigation menu">
            <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
            <a href="../../index.html">GraphSlim</a>
        </nav>

        <div class="wy-nav-content">
            <div class="rst-content">
                <div role="navigation" aria-label="Page navigation">
                    <ul class="wy-breadcrumbs">
                        <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
                        <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
                        <li class="breadcrumb-item active">graphslim.utils</li>
                        <li class="wy-breadcrumbs-aside">
                        </li>
                    </ul>
                    <hr/>
                </div>
                <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
                    <div itemprop="articleBody">

                        <h1>Source code for graphslim.utils</h1>
                        <div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">random</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span
                                class="nn">F</span>
<span class="kn">import</span> <span class="nn">torch.sparse</span> <span class="k">as</span> <span class="nn">ts</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span
                                class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">torch_sparse</span> <span class="kn">import</span> <span class="n">SparseTensor</span>
<span class="kn">from</span> <span class="nn">torch_geometric.utils</span> <span class="kn">import</span> <span
                                class="n">degree</span>
<span class="kn">import</span> <span class="nn">scipy.sparse</span> <span class="k">as</span> <span class="nn">sp</span>


<span class="c1"># from deeprobust.graph.utils import *</span>
<div class="viewcode-block" id="is_identity"><a class="viewcode-back"
                                                href="../../source/graphslim.html#graphslim.utils.is_identity">[docs]</a><span
        class="k">def</span> <span class="nf">is_identity</span><span class="p">(</span><span class="n">mx</span><span
        class="p">,</span> <span class="n">device</span><span class="p">):</span>
    <span class="n">identity</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span
            class="n">eye</span><span class="p">(</span><span class="n">mx</span><span class="o">.</span><span
            class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span
            class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mx</span><span
            class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span
            class="p">):</span>
        <span class="k">if</span> <span class="n">is_sparse_tensor</span><span class="p">(</span><span
            class="n">mx</span><span class="p">):</span>
            <span class="n">dense_tensor</span> <span class="o">=</span> <span class="n">mx</span><span
            class="o">.</span><span class="n">to_dense</span><span class="p">()</span><span class="o">.</span><span
            class="n">float</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dense_tensor</span> <span class="o">=</span> <span class="n">mx</span><span
            class="o">.</span><span class="n">float</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mx</span><span
            class="p">,</span> <span class="n">SparseTensor</span><span class="p">):</span>
        <span class="n">dense_tensor</span> <span class="o">=</span> <span class="n">mx</span><span
            class="o">.</span><span class="n">to_dense</span><span class="p">()</span><span class="o">.</span><span
            class="n">float</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input must be a torch.Tensor or torch.sparse.FloatTensor or torch_sparse.SparseTensor&quot;</span><span
            class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span
            class="n">allclose</span><span class="p">(</span><span class="n">dense_tensor</span><span class="p">,</span> <span
            class="n">identity</span><span class="p">)</span></div>


<div class="viewcode-block" id="seed_everything"><a class="viewcode-back"
                                                    href="../../source/graphslim.html#graphslim.utils.seed_everything">[docs]</a><span
        class="k">def</span> <span class="nf">seed_everything</span><span class="p">(</span><span
        class="n">seed</span><span class="p">):</span>
    <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span
            class="n">seed</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span
            class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span
            class="n">seed</span><span class="p">)</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span
            class="n">manual_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span
            class="s1">&#39;PYTHONHASHSEED&#39;</span><span class="p">]</span> <span class="o">=</span> <span
            class="nb">str</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span></div>


<div class="viewcode-block" id="regularization"><a class="viewcode-back"
                                                   href="../../source/graphslim.html#graphslim.utils.regularization">[docs]</a><span
        class="k">def</span> <span class="nf">regularization</span><span class="p">(</span><span
        class="n">adj</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">eig_real</span><span
        class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># fLf</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># loss += torch.norm(adj, p=1)</span>
    <span class="n">loss</span> <span class="o">+=</span> <span class="n">feature_smoothing</span><span
            class="p">(</span><span class="n">adj</span><span class="p">,</span> <span class="n">x</span><span
            class="p">)</span>
    <span class="k">return</span> <span class="n">loss</span></div>


<div class="viewcode-block" id="maxdegree"><a class="viewcode-back"
                                              href="../../source/graphslim.html#graphslim.utils.maxdegree">[docs]</a><span
        class="k">def</span> <span class="nf">maxdegree</span><span class="p">(</span><span class="n">adj</span><span
        class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">adj</span><span class="o">.</span><span class="n">shape</span><span
            class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span
            class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">adj</span><span
            class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span
            class="p">))</span> <span class="o">/</span> <span class="n">n</span> <span class="o">-</span> <span
            class="mf">0.5</span><span class="p">)</span></div>


<div class="viewcode-block" id="sparsity2"><a class="viewcode-back"
                                              href="../../source/graphslim.html#graphslim.utils.sparsity2">[docs]</a><span
        class="k">def</span> <span class="nf">sparsity2</span><span class="p">(</span><span class="n">adj</span><span
        class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">adj</span><span class="o">.</span><span class="n">shape</span><span
            class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">loss_degree</span> <span class="o">=</span> <span class="o">-</span> <span
            class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span
            class="n">adj</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span
            class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span
            class="p">()</span> <span class="o">/</span> <span class="n">n</span>
    <span class="n">loss_fro</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span
            class="n">norm</span><span class="p">(</span><span class="n">adj</span><span class="p">)</span> <span
            class="o">/</span> <span class="n">n</span>
    <span class="k">return</span> <span class="mi">0</span> <span class="o">*</span> <span class="n">loss_degree</span> <span
            class="o">+</span> <span class="n">loss_fro</span></div>


<div class="viewcode-block" id="sparsity"><a class="viewcode-back"
                                             href="../../source/graphslim.html#graphslim.utils.sparsity">[docs]</a><span
        class="k">def</span> <span class="nf">sparsity</span><span class="p">(</span><span class="n">adj</span><span
        class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">adj</span><span class="o">.</span><span class="n">shape</span><span
            class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">thresh</span> <span class="o">=</span> <span class="n">n</span> <span class="o">*</span> <span
            class="n">n</span> <span class="o">*</span> <span class="mf">0.01</span>
    <span class="k">return</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span
            class="p">(</span><span class="n">adj</span><span class="o">.</span><span class="n">sum</span><span
            class="p">()</span> <span class="o">-</span> <span class="n">thresh</span><span class="p">)</span></div>
    <span class="c1"># return F.relu(adj.sum()-thresh) / n**2</span>


<div class="viewcode-block" id="feature_smoothing"><a class="viewcode-back"
                                                      href="../../source/graphslim.html#graphslim.utils.feature_smoothing">[docs]</a><span
        class="k">def</span> <span class="nf">feature_smoothing</span><span class="p">(</span><span class="n">adj</span><span
        class="p">,</span> <span class="n">X</span><span class="p">):</span>
    <span class="n">adj</span> <span class="o">=</span> <span class="p">(</span><span class="n">adj</span><span
            class="o">.</span><span class="n">t</span><span class="p">()</span> <span class="o">+</span> <span
            class="n">adj</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">rowsum</span> <span class="o">=</span> <span class="n">adj</span><span class="o">.</span><span
            class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">r_inv</span> <span class="o">=</span> <span class="n">rowsum</span><span class="o">.</span><span
            class="n">flatten</span><span class="p">()</span>
    <span class="n">D</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span
            class="n">diag</span><span class="p">(</span><span class="n">r_inv</span><span class="p">)</span>
    <span class="n">L</span> <span class="o">=</span> <span class="n">D</span> <span class="o">-</span> <span class="n">adj</span>

    <span class="n">r_inv</span> <span class="o">=</span> <span class="n">r_inv</span> <span class="o">+</span> <span
            class="mf">1e-8</span>
    <span class="n">r_inv</span> <span class="o">=</span> <span class="n">r_inv</span><span class="o">.</span><span
            class="n">pow</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span
            class="o">/</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span
            class="p">()</span>
    <span class="n">r_inv</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span
            class="n">isinf</span><span class="p">(</span><span class="n">r_inv</span><span class="p">)]</span> <span
            class="o">=</span> <span class="mf">0.</span>
    <span class="n">r_mat_inv</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span
            class="n">diag</span><span class="p">(</span><span class="n">r_inv</span><span class="p">)</span>
    <span class="c1"># L = r_mat_inv @ L</span>
    <span class="n">L</span> <span class="o">=</span> <span class="n">r_mat_inv</span> <span class="o">@</span> <span
            class="n">L</span> <span class="o">@</span> <span class="n">r_mat_inv</span>

    <span class="n">XLXT</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span
            class="n">matmul</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span
            class="n">matmul</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span
            class="n">t</span><span class="p">(),</span> <span class="n">L</span><span class="p">),</span> <span
            class="n">X</span><span class="p">)</span>
    <span class="n">loss_smooth_feat</span> <span class="o">=</span> <span class="n">torch</span><span
            class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">XLXT</span><span
            class="p">)</span>
    <span class="c1"># loss_smooth_feat = loss_smooth_feat / (adj.shape[0]**2)</span>
    <span class="k">return</span> <span class="n">loss_smooth_feat</span></div>


<div class="viewcode-block" id="row_normalize_tensor"><a class="viewcode-back"
                                                         href="../../source/graphslim.html#graphslim.utils.row_normalize_tensor">[docs]</a><span
        class="k">def</span> <span class="nf">row_normalize_tensor</span><span class="p">(</span><span
        class="n">mx</span><span class="p">):</span>
    <span class="n">mx</span> <span class="o">-=</span> <span class="n">mx</span><span class="o">.</span><span
            class="n">min</span><span class="p">()</span>
    <span class="n">rowsum</span> <span class="o">=</span> <span class="n">mx</span><span class="o">.</span><span
            class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">r_inv</span> <span class="o">=</span> <span class="n">rowsum</span><span class="o">.</span><span
            class="n">pow</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span
            class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="c1"># r_inv[torch.isinf(r_inv)] = 0.</span>
    <span class="n">r_mat_inv</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span
            class="n">diag</span><span class="p">(</span><span class="n">r_inv</span><span class="p">)</span>
    <span class="n">mx</span> <span class="o">=</span> <span class="n">r_mat_inv</span> <span class="o">@</span> <span
            class="n">mx</span>
    <span class="k">return</span> <span class="n">mx</span></div>


<span class="c1"># sfgc utils#</span>

<div class="viewcode-block" id="one_hot_sfgc"><a class="viewcode-back"
                                                 href="../../source/graphslim.html#graphslim.utils.one_hot_sfgc">[docs]</a><span
        class="k">def</span> <span class="nf">one_hot_sfgc</span><span class="p">(</span><span class="n">x</span><span
        class="p">,</span>
                 <span class="n">num_classes</span><span class="p">,</span>
                 <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span
            class="p">,</span>
                 <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span
            class="o">.</span><span class="n">float32</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span
            class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span
            class="mi">1</span>
    <span class="n">one_hot_vectors</span> <span class="o">=</span> <span class="n">np</span><span
            class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span
            class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">==</span> <span
            class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span
            class="n">num_classes</span><span class="p">),</span> <span class="n">dtype</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">center</span><span class="p">:</span>
        <span class="n">one_hot_vectors</span> <span class="o">=</span> <span class="n">one_hot_vectors</span> <span
            class="o">-</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">num_classes</span>
    <span class="k">return</span> <span class="n">one_hot_vectors</span></div>


<div class="viewcode-block" id="calc"><a class="viewcode-back" href="../../source/graphslim.html#graphslim.utils.calc">[docs]</a><span
        class="k">def</span> <span class="nf">calc</span><span class="p">(</span><span class="n">gntk</span><span
        class="p">,</span> <span class="n">feat1</span><span class="p">,</span> <span class="n">feat2</span><span
        class="p">,</span> <span class="n">diag1</span><span class="p">,</span> <span class="n">diag2</span><span
        class="p">,</span> <span class="n">A1</span><span class="p">,</span> <span class="n">A2</span><span
        class="p">):</span>
    <span class="k">return</span> <span class="n">gntk</span><span class="o">.</span><span class="n">gntk</span><span
            class="p">(</span><span class="n">feat1</span><span class="p">,</span> <span class="n">feat2</span><span
            class="p">,</span> <span class="n">diag1</span><span class="p">,</span> <span class="n">diag2</span><span
            class="p">,</span> <span class="n">A1</span><span class="p">,</span> <span class="n">A2</span><span
            class="p">)</span></div>


<span class="c1"># def loss_acc_fn_train(data, k_ss, k_ts, y_support, y_target, reg=5e-2):</span>
<span class="c1">#     # print(k_ss.device, torch.abs(torch.tensor(reg)).to(k_ss.device),torch.trace(k_ss).device, torch.eye(k_ss.shape[0]).device)</span>
<span class="c1">#     k_ss_reg = (k_ss + torch.abs(torch.tensor(reg)).to(k_ss.device) * torch.trace(k_ss).to(k_ss.device) * torch.eye(</span>
<span class="c1">#         k_ss.shape[0]).to(k_ss.device) / k_ss.shape[0])</span>
<span class="c1">#     pred = torch.matmul(k_ts[data.idx_train, :].cuda(), torch.matmul(torch.linalg.inv(k_ss_reg).cuda(),</span>
<span class="c1">#                                                                      torch.from_numpy(y_support).to(</span>
<span class="c1">#                                                                          torch.float64).cuda()))</span>
<span class="c1">#     mse_loss = torch.nn.functional.mse_loss(pred.to(torch.float64).cuda(),</span>
<span class="c1">#                                             torch.from_numpy(y_target).to(torch.float64).cuda(), reduction=&quot;mean&quot;)</span>
<span class="c1">#     acc = 0</span>
<span class="c1">#     return mse_loss, acc</span>


<div class="viewcode-block" id="loss_acc_fn_eval"><a class="viewcode-back"
                                                     href="../../source/graphslim.html#graphslim.utils.loss_acc_fn_eval">[docs]</a><span
        class="k">def</span> <span class="nf">loss_acc_fn_eval</span><span class="p">(</span><span class="n">data</span><span
        class="p">,</span> <span class="n">k_ss</span><span class="p">,</span> <span class="n">k_ts</span><span
        class="p">,</span> <span class="n">y_support</span><span class="p">,</span> <span class="n">y_target</span><span
        class="p">,</span> <span class="n">reg</span><span class="o">=</span><span class="mf">5e-2</span><span
        class="p">):</span>
    <span class="n">k_ss_reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">k_ss</span> <span
            class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span
            class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="o">*</span> <span
            class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span
            class="n">k_ss</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span
            class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">k_ss</span><span
            class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span
            class="p">])</span> <span class="o">/</span> <span class="n">k_ss</span><span class="o">.</span><span
            class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span
            class="n">dot</span><span class="p">(</span><span class="n">k_ts</span><span class="p">,</span> <span
            class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span
            class="n">inv</span><span class="p">(</span><span class="n">k_ss_reg</span><span class="p">)</span><span
            class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">y_support</span><span
            class="p">))</span>
    <span class="n">mse_loss</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span
            class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span
            class="n">pred</span> <span class="o">-</span> <span class="n">y_target</span><span class="p">)</span> <span
            class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span
            class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span
            class="n">argmax</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span
            class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span
            class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span
            class="p">(</span><span class="n">y_target</span><span class="p">,</span> <span class="n">axis</span><span
            class="o">=</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">mse_loss</span><span class="p">,</span> <span
            class="n">acc</span></div>


<span class="c1"># =================scaling up========#</span>


<div class="viewcode-block" id="one_hot"><a class="viewcode-back"
                                            href="../../source/graphslim.html#graphslim.utils.one_hot">[docs]</a><span
        class="k">def</span> <span class="nf">one_hot</span><span class="p">(</span><span class="n">x</span><span
        class="p">,</span> <span class="n">class_count</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">eye</span><span
            class="p">(</span><span class="n">class_count</span><span class="p">)[</span><span class="n">x</span><span
            class="p">,</span> <span class="p">:]</span></div>


<div class="viewcode-block" id="mask_to_index"><a class="viewcode-back"
                                                  href="../../source/graphslim.html#graphslim.utils.mask_to_index">[docs]</a><span
        class="k">def</span> <span class="nf">mask_to_index</span><span class="p">(</span><span
        class="n">index</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
    <span class="n">all_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span
            class="n">arange</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">all_idx</span><span class="p">[</span><span
            class="n">index</span><span class="p">]</span></div>


<span class="k">def</span> <span class="nf">index_to_mask</span><span class="p">(</span><span
                                class="n">index</span><span class="p">,</span> <span class="n">size</span><span
                                class="p">):</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span
                                class="n">zeros</span><span class="p">((</span><span class="n">size</span><span
                                class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span
                                class="n">torch</span><span class="o">.</span><span class="n">bool</span><span
                                class="p">)</span>
    <span class="n">mask</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span
                                class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">mask</span>
<div class="viewcode-block" id="to_camel_case"><a class="viewcode-back"
                                                  href="../../source/graphslim.html#graphslim.utils.to_camel_case">[docs]</a><span
        class="k">def</span> <span class="nf">to_camel_case</span><span class="p">(</span><span
        class="n">snake_str</span><span class="p">):</span>
    <span class="n">components</span> <span class="o">=</span> <span class="n">snake_str</span><span
            class="o">.</span><span class="n">split</span><span class="p">(</span><span
            class="s1">&#39;_&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span
            class="n">join</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span
            class="n">title</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span
            class="ow">in</span> <span class="n">components</span><span class="p">)</span></div>

<span class="c1"># def cal_storage(data, setting):</span>
<span class="c1">#     if setting == &#39;trans&#39;:</span>
<span class="c1">#         origin_storage = getsize_mb([data.x, data.edge_index, data.y])</span>
<span class="c1">#     else:</span>
<span class="c1">#         origin_storage = getsize_mb([data.feat_train, data.adj_train, data.labels_train])</span>
<span class="c1">#     condensed_storage = getsize_mb([data.feat_syn, data.adj_syn, data.labels_syn])</span>
<span class="c1">#     print(f&#39;Origin graph:{origin_storage:.2f}Mb  Condensed graph:{condensed_storage:.2f}Mb&#39;)</span>

<div class="viewcode-block" id="to_tensor"><a class="viewcode-back"
                                              href="../../source/graphslim.html#graphslim.utils.to_tensor">[docs]</a><span
        class="k">def</span> <span class="nf">to_tensor</span><span class="p">(</span><span class="o">*</span><span
        class="nb">vars</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span
        class="p">):</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span
            class="n">get</span><span class="p">(</span><span class="s1">&#39;device&#39;</span><span class="p">,</span> <span
            class="s1">&#39;cpu&#39;</span><span class="p">)</span>
    <span class="n">tensor_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">vars</span><span
            class="p">:</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">check_type</span><span
            class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">device</span><span
            class="p">)</span>
        <span class="n">tensor_list</span><span class="o">.</span><span class="n">append</span><span
            class="p">(</span><span class="n">var</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span
            class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span
            class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span
            class="s1">&#39;device&#39;</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">check_type</span><span
            class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">device</span><span
            class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;label&#39;</span> <span class="ow">in</span> <span
            class="n">key</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span
            class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span
            class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">tensor</span> <span class="o">=</span> <span class="n">value</span><span
            class="o">.</span><span class="n">long</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tensor</span> <span class="o">=</span> <span class="n">value</span>
            <span class="n">tensor_list</span><span class="o">.</span><span class="n">append</span><span
            class="p">(</span><span class="n">tensor</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tensor_list</span><span
            class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">tensor_list</span><span class="p">[</span><span
            class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">tensor_list</span></div>


<div class="viewcode-block" id="check_type"><a class="viewcode-back"
                                               href="../../source/graphslim.html#graphslim.utils.check_type">[docs]</a><span
        class="k">def</span> <span class="nf">check_type</span><span class="p">(</span><span class="n">var</span><span
        class="p">,</span> <span class="n">device</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">sp</span><span class="o">.</span><span class="n">issparse</span><span
            class="p">(</span><span class="n">var</span><span class="p">):</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">sparse_mx_to_torch_sparse_tensor</span><span
            class="p">(</span><span class="n">var</span><span class="p">)</span><span class="o">.</span><span class="n">coalesce</span><span
            class="p">()</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span
            class="n">var</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span
            class="n">ndarray</span><span class="p">):</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span
            class="n">from_numpy</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="n">var</span><span class="o">.</span><span class="n">float</span><span
            class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span
            class="p">)</span></div>


<span class="c1"># ============the following is copy from deeprobust/graph/utils.py=================</span>
<span class="kn">import</span> <span class="nn">scipy.sparse</span> <span class="k">as</span> <span class="nn">sp</span>


<div class="viewcode-block" id="encode_onehot"><a class="viewcode-back"
                                                  href="../../source/graphslim.html#graphslim.utils.encode_onehot">[docs]</a><span
        class="k">def</span> <span class="nf">encode_onehot</span><span class="p">(</span><span
        class="n">labels</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert label to onehot format.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    labels : numpy.array</span>
<span class="sd">        node labels</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    numpy.array</span>
<span class="sd">        onehot labels</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">eye</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span
            class="n">eye</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span
            class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span
            class="p">)</span>
    <span class="n">onehot_mx</span> <span class="o">=</span> <span class="n">eye</span><span class="p">[</span><span
            class="n">labels</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">onehot_mx</span></div>


<div class="viewcode-block" id="tensor2onehot"><a class="viewcode-back"
                                                  href="../../source/graphslim.html#graphslim.utils.tensor2onehot">[docs]</a><span
        class="k">def</span> <span class="nf">tensor2onehot</span><span class="p">(</span><span
        class="n">labels</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert label tensor to label onehot tensor.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    labels : torch.LongTensor</span>
<span class="sd">        node labels</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    torch.LongTensor</span>
<span class="sd">        onehot labels tensor</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">eye</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span
            class="n">eye</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span
            class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span
            class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">labels</span><span
            class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="n">onehot_mx</span> <span class="o">=</span> <span class="n">eye</span><span class="p">[</span><span
            class="n">labels</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">onehot_mx</span></div>


<div class="viewcode-block" id="normalize_feature"><a class="viewcode-back"
                                                      href="../../source/graphslim.html#graphslim.utils.normalize_feature">[docs]</a><span
        class="k">def</span> <span class="nf">normalize_feature</span><span class="p">(</span><span
        class="n">mx</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Row-normalize sparse matrix or dense matrix</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mx : scipy.sparse.csr_matrix or numpy.array</span>
<span class="sd">        matrix to be normalized</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    scipy.sprase.lil_matrix</span>
<span class="sd">        normalized matrix</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">mx</span><span
            class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">sp</span><span
            class="o">.</span><span class="n">lil</span><span class="o">.</span><span class="n">lil_matrix</span><span
            class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mx</span> <span class="o">=</span> <span class="n">mx</span><span class="o">.</span><span
            class="n">tolil</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="n">rowsum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span
            class="n">array</span><span class="p">(</span><span class="n">mx</span><span class="o">.</span><span
            class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">r_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span
            class="n">power</span><span class="p">(</span><span class="n">rowsum</span><span class="p">,</span> <span
            class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span
            class="p">()</span>
    <span class="n">r_inv</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span
            class="n">isinf</span><span class="p">(</span><span class="n">r_inv</span><span class="p">)]</span> <span
            class="o">=</span> <span class="mf">0.</span>
    <span class="n">r_mat_inv</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span
            class="n">diags</span><span class="p">(</span><span class="n">r_inv</span><span class="p">)</span>
    <span class="n">mx</span> <span class="o">=</span> <span class="n">r_mat_inv</span><span class="o">.</span><span
            class="n">dot</span><span class="p">(</span><span class="n">mx</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mx</span></div>


<span class="k">def</span> <span class="nf">normalize_adj</span><span class="p">(</span><span class="n">mx</span><span
                                class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Normalize sparse adjacency matrix,</span>
<span class="sd">    A&#39; = (D + I)^-1/2 * ( A + I ) * (D + I)^-1/2</span>
<span class="sd">    Row-normalize sparse matrix</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mx : scipy.sparse.csr_matrix</span>
<span class="sd">        matrix to be normalized</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    scipy.sprase.lil_matrix</span>
<span class="sd">        normalized matrix</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">mx</span><span
                                class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span
                                class="n">sp</span><span class="o">.</span><span class="n">lil</span><span
                                class="o">.</span><span class="n">lil_matrix</span><span class="p">:</span>
        <span class="n">mx</span> <span class="o">=</span> <span class="n">mx</span><span class="o">.</span><span
                                class="n">tolil</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">mx</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span
                                class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span
                                class="mi">0</span><span class="p">:</span>
        <span class="n">mx</span> <span class="o">=</span> <span class="n">mx</span> <span class="o">+</span> <span
                                class="n">sp</span><span class="o">.</span><span class="n">eye</span><span
                                class="p">(</span><span class="n">mx</span><span class="o">.</span><span
                                class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">eps</span> <span class="o">=</span> <span class="mf">1e-9</span>
    <span class="n">rowsum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span
                                class="n">array</span><span class="p">(</span><span class="n">mx</span><span
                                class="o">.</span><span class="n">sum</span><span class="p">(</span><span
                                class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="n">eps</span>
    <span class="n">r_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span
                                class="n">power</span><span class="p">(</span><span class="n">rowsum</span><span
                                class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span
                                class="o">/</span> <span class="mi">2</span><span class="p">)</span><span
                                class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">r_inv</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span
                                class="n">isinf</span><span class="p">(</span><span class="n">r_inv</span><span
                                class="p">)]</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">r_mat_inv</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span
                                class="n">diags</span><span class="p">(</span><span class="n">r_inv</span><span
                                class="p">)</span>
    <span class="n">mx</span> <span class="o">=</span> <span class="n">r_mat_inv</span><span class="o">.</span><span
                                class="n">dot</span><span class="p">(</span><span class="n">mx</span><span
                                class="p">)</span>
    <span class="n">mx</span> <span class="o">=</span> <span class="n">mx</span><span class="o">.</span><span class="n">dot</span><span
                                class="p">(</span><span class="n">r_mat_inv</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mx</span>


<div class="viewcode-block" id="normalize_sparse_tensor"><a class="viewcode-back"
                                                            href="../../source/graphslim.html#graphslim.utils.normalize_sparse_tensor">[docs]</a><span
        class="k">def</span> <span class="nf">normalize_sparse_tensor</span><span class="p">(</span><span
        class="n">adj</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span
        class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span
            class="sd">&quot;&quot;&quot;Normalize sparse tensor. Need to import torch_scatter</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">edge_index</span> <span class="o">=</span> <span class="n">adj</span><span class="o">.</span><span
            class="n">_indices</span><span class="p">()</span>
    <span class="n">edge_weight</span> <span class="o">=</span> <span class="n">adj</span><span class="o">.</span><span
            class="n">_values</span><span class="p">()</span>
    <span class="n">num_nodes</span> <span class="o">=</span> <span class="n">adj</span><span class="o">.</span><span
            class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">edge_index</span><span class="p">,</span> <span class="n">edge_weight</span> <span
            class="o">=</span> <span class="n">add_self_loops</span><span class="p">(</span>
        <span class="n">edge_index</span><span class="p">,</span> <span class="n">edge_weight</span><span
            class="p">,</span> <span class="n">fill_value</span><span class="p">,</span> <span
            class="n">num_nodes</span><span class="p">)</span>

    <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span
            class="n">edge_index</span>
    <span class="kn">from</span> <span class="nn">torch_scatter</span> <span class="kn">import</span> <span class="n">scatter_add</span>
    <span class="n">deg</span> <span class="o">=</span> <span class="n">scatter_add</span><span class="p">(</span><span
            class="n">edge_weight</span><span class="p">,</span> <span class="n">row</span><span
            class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span
            class="p">,</span> <span class="n">dim_size</span><span class="o">=</span><span
            class="n">num_nodes</span><span class="p">)</span>
    <span class="n">deg_inv_sqrt</span> <span class="o">=</span> <span class="n">deg</span><span class="o">.</span><span
            class="n">pow</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span
            class="p">)</span>
    <span class="n">deg_inv_sqrt</span><span class="p">[</span><span class="n">deg_inv_sqrt</span> <span
            class="o">==</span> <span class="nb">float</span><span class="p">(</span><span
            class="s1">&#39;inf&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">values</span> <span class="o">=</span> <span class="n">deg_inv_sqrt</span><span
            class="p">[</span><span class="n">row</span><span class="p">]</span> <span class="o">*</span> <span
            class="n">edge_weight</span> <span class="o">*</span> <span class="n">deg_inv_sqrt</span><span
            class="p">[</span><span class="n">col</span><span class="p">]</span>

    <span class="n">shape</span> <span class="o">=</span> <span class="n">adj</span><span class="o">.</span><span
            class="n">shape</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">sparse</span><span
            class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span
            class="n">edge_index</span><span class="p">,</span> <span class="n">values</span><span
            class="p">,</span> <span class="n">shape</span><span class="p">)</span></div>


<div class="viewcode-block" id="add_self_loops"><a class="viewcode-back"
                                                   href="../../source/graphslim.html#graphslim.utils.add_self_loops">[docs]</a><span
        class="k">def</span> <span class="nf">add_self_loops</span><span class="p">(</span><span
        class="n">edge_index</span><span class="p">,</span> <span class="n">edge_weight</span><span
        class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fill_value</span><span
        class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_nodes</span><span
        class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># num_nodes = maybe_num_nodes(edge_index, num_nodes)</span>

    <span class="n">loop_index</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span
            class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span
            class="n">num_nodes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span
            class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">,</span>
                              <span class="n">device</span><span class="o">=</span><span
            class="n">edge_index</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="n">loop_index</span> <span class="o">=</span> <span class="n">loop_index</span><span class="o">.</span><span
            class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span
            class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">2</span><span
            class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">edge_weight</span> <span class="ow">is</span> <span class="ow">not</span> <span
            class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">edge_weight</span><span class="o">.</span><span
            class="n">numel</span><span class="p">()</span> <span class="o">==</span> <span
            class="n">edge_index</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span
            class="mi">1</span><span class="p">)</span>
        <span class="n">loop_weight</span> <span class="o">=</span> <span class="n">edge_weight</span><span
            class="o">.</span><span class="n">new_full</span><span class="p">((</span><span
            class="n">num_nodes</span><span class="p">,),</span> <span class="n">fill_value</span><span
            class="p">)</span>
        <span class="n">edge_weight</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span
            class="n">cat</span><span class="p">([</span><span class="n">edge_weight</span><span
            class="p">,</span> <span class="n">loop_weight</span><span class="p">],</span> <span
            class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">edge_index</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span
            class="n">cat</span><span class="p">([</span><span class="n">edge_index</span><span class="p">,</span> <span
            class="n">loop_index</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span
            class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">edge_index</span><span class="p">,</span> <span
            class="n">edge_weight</span></div>


<div class="viewcode-block" id="normalize_adj_sgformer"><a class="viewcode-back"
                                                           href="../../source/graphslim.html#graphslim.utils.normalize_adj_sgformer">[docs]</a><span
        class="k">def</span> <span class="nf">normalize_adj_sgformer</span><span class="p">(</span><span
        class="n">adj</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Normalize the adjacency matrix. Works for both dense and sparse matrices.</span>

<span class="sd">    Args:</span>
<span class="sd">    adj (torch.Tensor): The adjacency matrix (either dense or sparse COO).</span>
<span class="sd">    device (torch.device): The device to run the normalization on.</span>

<span class="sd">    Returns:</span>
<span class="sd">    torch.Tensor or SparseTensor: The normalized adjacency matrix.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># if is_sparse_tensor(adj):</span>
    <span class="c1">#     # Sparse matrix normalization</span>
    <span class="c1">#     row = adj.indices()[0]</span>
    <span class="c1">#     col = adj.indices()[1]</span>
    <span class="c1">#     values = adj.values()</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">adj</span><span
            class="p">,</span> <span class="n">SparseTensor</span><span class="p">):</span>
        <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span
            class="n">values</span> <span class="o">=</span> <span class="n">adj</span><span class="o">.</span><span
            class="n">coo</span><span class="p">()</span>
        <span class="c1"># Number of nodes</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">adj</span><span class="o">.</span><span
            class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Compute degree for normalization</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">degree</span><span class="p">(</span><span
            class="n">col</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span><span
            class="o">.</span><span class="n">float</span><span class="p">()</span>
        <span class="n">d_norm_in</span> <span class="o">=</span> <span class="p">(</span><span
            class="mf">1.</span> <span class="o">/</span> <span class="n">d</span><span class="p">[</span><span
            class="n">col</span><span class="p">])</span><span class="o">.</span><span class="n">sqrt</span><span
            class="p">()</span>
        <span class="n">d_norm_out</span> <span class="o">=</span> <span class="p">(</span><span
            class="mf">1.</span> <span class="o">/</span> <span class="n">d</span><span class="p">[</span><span
            class="n">row</span><span class="p">])</span><span class="o">.</span><span class="n">sqrt</span><span
            class="p">()</span>

        <span class="c1"># Normalize the values directly</span>
        <span class="n">normalized_values</span> <span class="o">=</span> <span class="n">values</span> <span class="o">*</span> <span
            class="n">d_norm_in</span> <span class="o">*</span> <span class="n">d_norm_out</span>
        <span class="n">normalized_values</span> <span class="o">=</span> <span class="n">torch</span><span
            class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span
            class="n">normalized_values</span><span class="p">,</span> <span class="n">nan</span><span
            class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">posinf</span><span
            class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">neginf</span><span
            class="o">=</span><span class="mf">0.0</span><span class="p">)</span>

        <span class="c1"># Create a new SparseTensor with normalized values</span>
        <span class="n">adj_normalized</span> <span class="o">=</span> <span class="n">SparseTensor</span><span
            class="p">(</span><span class="n">row</span><span class="o">=</span><span class="n">row</span><span
            class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="n">col</span><span
            class="p">,</span> <span class="n">value</span><span class="o">=</span><span
            class="n">normalized_values</span><span class="p">,</span> <span class="n">sparse_sizes</span><span
            class="o">=</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span
            class="n">N</span><span class="p">))</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Dense matrix normalization</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">adj</span><span class="o">.</span><span
            class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Compute degree for normalization</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">adj</span><span class="o">.</span><span
            class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span
            class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span
            class="p">()</span>
        <span class="n">d_norm</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span
            class="n">diag</span><span class="p">((</span><span class="mf">1.</span> <span class="o">/</span> <span
            class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">sqrt</span><span
            class="p">())</span>

        <span class="c1"># Normalize the dense adjacency matrix</span>
        <span class="n">adj_normalized</span> <span class="o">=</span> <span class="n">d_norm</span> <span
            class="o">@</span> <span class="n">adj</span> <span class="o">@</span> <span class="n">d_norm</span>
        <span class="n">adj_normalized</span> <span class="o">=</span> <span class="n">torch</span><span
            class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span
            class="n">adj_normalized</span><span class="p">,</span> <span class="n">nan</span><span
            class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">posinf</span><span
            class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">neginf</span><span
            class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">adj_normalized</span></div>


<div class="viewcode-block" id="normalize_adj_tensor"><a class="viewcode-back"
                                                         href="../../source/graphslim.html#graphslim.utils.normalize_adj_tensor">[docs]</a><span
        class="k">def</span> <span class="nf">normalize_adj_tensor</span><span class="p">(</span><span
        class="n">adj</span><span class="p">,</span> <span class="n">sparse</span><span class="o">=</span><span
        class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Normalize adjacency tensor matrix.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">adj</span><span class="o">.</span><span
            class="n">device</span>
    <span class="k">if</span> <span class="n">sparse</span><span class="p">:</span>
        <span class="n">adj</span> <span class="o">=</span> <span class="n">to_scipy</span><span class="p">(</span><span
            class="n">adj</span><span class="p">)</span>
        <span class="n">mx</span> <span class="o">=</span> <span class="n">normalize_adj</span><span
            class="p">(</span><span class="n">adj</span><span class="p">)</span>
        <span class="n">adj</span> <span class="o">=</span> <span class="n">sparse_mx_to_torch_sparse_tensor</span><span
            class="p">(</span><span class="n">mx</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span
            class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span
            class="n">coalesce</span><span class="p">()</span>
        <span class="n">adj</span> <span class="o">=</span> <span class="n">SparseTensor</span><span
            class="p">(</span><span class="n">row</span><span class="o">=</span><span class="n">adj</span><span
            class="o">.</span><span class="n">indices</span><span class="p">()[</span><span class="mi">0</span><span
            class="p">],</span> <span class="n">col</span><span class="o">=</span><span class="n">adj</span><span
            class="o">.</span><span class="n">indices</span><span class="p">()[</span><span class="mi">1</span><span
            class="p">],</span>
                           <span class="n">value</span><span class="o">=</span><span class="n">adj</span><span
            class="o">.</span><span class="n">values</span><span class="p">(),</span> <span
            class="n">sparse_sizes</span><span class="o">=</span><span class="n">adj</span><span class="o">.</span><span
            class="n">size</span><span class="p">())</span><span class="o">.</span><span class="n">t</span><span
            class="p">()</span>
        <span class="k">return</span> <span class="n">adj</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">adj</span><span
            class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span
            class="mi">3</span><span class="p">:</span>
            <span class="n">adjs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span
            class="p">(</span><span class="n">adj</span><span class="o">.</span><span class="n">shape</span><span
            class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">ad</span> <span class="o">=</span> <span class="n">adj</span><span
            class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">ad</span> <span class="o">=</span> <span class="n">dense_gcn_norm</span><span class="p">(</span><span
            class="n">ad</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
                <span class="n">adjs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span
            class="n">ad</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span
            class="n">stack</span><span class="p">(</span><span class="n">adjs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">adj</span> <span class="o">=</span> <span class="n">dense_gcn_norm</span><span
            class="p">(</span><span class="n">adj</span><span class="p">,</span> <span class="n">device</span><span
            class="p">)</span>

            <span class="k">return</span> <span class="n">adj</span></div>


<div class="viewcode-block" id="dense_gcn_norm"><a class="viewcode-back"
                                                   href="../../source/graphslim.html#graphslim.utils.dense_gcn_norm">[docs]</a><span
        class="k">def</span> <span class="nf">dense_gcn_norm</span><span class="p">(</span><span
        class="n">adj</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">adj</span><span
            class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">torch</span><span
            class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
        <span class="n">adj</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span
            class="n">from_numpy</span><span class="p">(</span><span class="n">adj</span><span class="p">)</span>
    <span class="n">mx</span> <span class="o">=</span> <span class="n">adj</span> <span class="o">+</span> <span
            class="n">torch</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span
            class="n">adj</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span
            class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span
            class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">rowsum</span> <span class="o">=</span> <span class="n">mx</span><span class="o">.</span><span
            class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">r_inv</span> <span class="o">=</span> <span class="n">rowsum</span><span class="o">.</span><span
            class="n">pow</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span
            class="o">/</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span
            class="p">()</span>
    <span class="n">r_inv</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span
            class="n">isinf</span><span class="p">(</span><span class="n">r_inv</span><span class="p">)]</span> <span
            class="o">=</span> <span class="mf">0.</span>
    <span class="n">r_mat_inv</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span
            class="n">diag</span><span class="p">(</span><span class="n">r_inv</span><span class="p">)</span>
    <span class="n">mx</span> <span class="o">=</span> <span class="n">r_mat_inv</span> <span class="o">@</span> <span
            class="n">mx</span>
    <span class="n">mx</span> <span class="o">=</span> <span class="n">mx</span> <span class="o">@</span> <span
            class="n">r_mat_inv</span>
    <span class="k">return</span> <span class="n">mx</span></div>


<div class="viewcode-block" id="normalize_adj"><a class="viewcode-back"
                                                  href="../../source/graphslim.html#graphslim.utils.normalize_adj">[docs]</a><span
        class="k">def</span> <span class="nf">normalize_adj</span><span class="p">(</span><span
        class="n">adj</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span
        class="s1">&#39;cpu&#39;</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">sp</span><span class="o">.</span><span class="n">issparse</span><span
            class="p">(</span><span class="n">adj</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">sparse_gcn_norm</span><span class="p">(</span><span
            class="n">adj</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">adj</span><span
            class="p">)</span> <span class="ow">is</span> <span class="n">torch</span><span class="o">.</span><span
            class="n">Tensor</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dense_gcn_norm</span><span class="p">(</span><span
            class="n">adj</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dense_gcn_norm</span><span class="p">(</span><span
            class="n">adj</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span><span
            class="o">.</span><span class="n">numpy</span><span class="p">()</span></div>


<div class="viewcode-block" id="sparse_gcn_norm"><a class="viewcode-back"
                                                    href="../../source/graphslim.html#graphslim.utils.sparse_gcn_norm">[docs]</a><span
        class="k">def</span> <span class="nf">sparse_gcn_norm</span><span class="p">(</span><span
        class="n">adj</span><span class="p">):</span>
    <span class="n">adj</span> <span class="o">=</span> <span class="n">adj</span> <span class="o">+</span> <span
            class="n">sp</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span
            class="n">adj</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span
            class="mi">0</span><span class="p">])</span>
    <span class="n">rowsum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span
            class="n">array</span><span class="p">(</span><span class="n">adj</span><span class="o">.</span><span
            class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">r_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span
            class="n">power</span><span class="p">(</span><span class="n">rowsum</span><span class="p">,</span> <span
            class="o">-</span><span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span
            class="n">flatten</span><span class="p">()</span>
    <span class="n">r_inv</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span
            class="n">isinf</span><span class="p">(</span><span class="n">r_inv</span><span class="p">)]</span> <span
            class="o">=</span> <span class="mf">0.</span>
    <span class="n">r_mat_inv</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span
            class="n">diags</span><span class="p">(</span><span class="n">r_inv</span><span class="p">)</span>
    <span class="n">adj</span> <span class="o">=</span> <span class="n">r_mat_inv</span><span class="o">.</span><span
            class="n">dot</span><span class="p">(</span><span class="n">adj</span><span class="p">)</span><span
            class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">r_mat_inv</span><span
            class="p">)</span>
    <span class="k">return</span> <span class="n">adj</span></div>


<div class="viewcode-block" id="degree_normalize_adj"><a class="viewcode-back"
                                                         href="../../source/graphslim.html#graphslim.utils.degree_normalize_adj">[docs]</a><span
        class="k">def</span> <span class="nf">degree_normalize_adj</span><span class="p">(</span><span
        class="n">mx</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Row-normalize sparse matrix&quot;&quot;&quot;</span>
    <span class="n">mx</span> <span class="o">=</span> <span class="n">mx</span><span class="o">.</span><span class="n">tolil</span><span
            class="p">()</span>
    <span class="k">if</span> <span class="n">mx</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span
            class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span
            class="p">:</span>
        <span class="n">mx</span> <span class="o">=</span> <span class="n">mx</span> <span class="o">+</span> <span
            class="n">sp</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span
            class="n">mx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span
            class="mi">0</span><span class="p">])</span>
    <span class="n">rowsum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span
            class="n">array</span><span class="p">(</span><span class="n">mx</span><span class="o">.</span><span
            class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">r_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span
            class="n">power</span><span class="p">(</span><span class="n">rowsum</span><span class="p">,</span> <span
            class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span
            class="p">()</span>
    <span class="n">r_inv</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span
            class="n">isinf</span><span class="p">(</span><span class="n">r_inv</span><span class="p">)]</span> <span
            class="o">=</span> <span class="mf">0.</span>
    <span class="n">r_mat_inv</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span
            class="n">diags</span><span class="p">(</span><span class="n">r_inv</span><span class="p">)</span>
    <span class="c1"># mx = mx.dot(r_mat_inv)</span>
    <span class="n">mx</span> <span class="o">=</span> <span class="n">r_mat_inv</span><span class="o">.</span><span
            class="n">dot</span><span class="p">(</span><span class="n">mx</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mx</span></div>


<div class="viewcode-block" id="degree_normalize_sparse_tensor"><a class="viewcode-back"
                                                                   href="../../source/graphslim.html#graphslim.utils.degree_normalize_sparse_tensor">[docs]</a><span
        class="k">def</span> <span class="nf">degree_normalize_sparse_tensor</span><span class="p">(</span><span
        class="n">adj</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span
        class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;degree_normalize_sparse_tensor.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">edge_index</span> <span class="o">=</span> <span class="n">adj</span><span class="o">.</span><span
            class="n">_indices</span><span class="p">()</span>
    <span class="n">edge_weight</span> <span class="o">=</span> <span class="n">adj</span><span class="o">.</span><span
            class="n">_values</span><span class="p">()</span>
    <span class="n">num_nodes</span> <span class="o">=</span> <span class="n">adj</span><span class="o">.</span><span
            class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">edge_index</span><span class="p">,</span> <span class="n">edge_weight</span> <span
            class="o">=</span> <span class="n">add_self_loops</span><span class="p">(</span>
        <span class="n">edge_index</span><span class="p">,</span> <span class="n">edge_weight</span><span
            class="p">,</span> <span class="n">fill_value</span><span class="p">,</span> <span
            class="n">num_nodes</span><span class="p">)</span>

    <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span
            class="n">edge_index</span>
    <span class="kn">from</span> <span class="nn">torch_scatter</span> <span class="kn">import</span> <span class="n">scatter_add</span>
    <span class="n">deg</span> <span class="o">=</span> <span class="n">scatter_add</span><span class="p">(</span><span
            class="n">edge_weight</span><span class="p">,</span> <span class="n">row</span><span
            class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span
            class="p">,</span> <span class="n">dim_size</span><span class="o">=</span><span
            class="n">num_nodes</span><span class="p">)</span>
    <span class="n">deg_inv_sqrt</span> <span class="o">=</span> <span class="n">deg</span><span class="o">.</span><span
            class="n">pow</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span
            class="p">)</span>
    <span class="n">deg_inv_sqrt</span><span class="p">[</span><span class="n">deg_inv_sqrt</span> <span
            class="o">==</span> <span class="nb">float</span><span class="p">(</span><span
            class="s1">&#39;inf&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">values</span> <span class="o">=</span> <span class="n">deg_inv_sqrt</span><span
            class="p">[</span><span class="n">row</span><span class="p">]</span> <span class="o">*</span> <span
            class="n">edge_weight</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="n">adj</span><span class="o">.</span><span
            class="n">shape</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">sparse</span><span
            class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span
            class="n">edge_index</span><span class="p">,</span> <span class="n">values</span><span
            class="p">,</span> <span class="n">shape</span><span class="p">)</span></div>


<div class="viewcode-block" id="degree_normalize_adj_tensor"><a class="viewcode-back"
                                                                href="../../source/graphslim.html#graphslim.utils.degree_normalize_adj_tensor">[docs]</a><span
        class="k">def</span> <span class="nf">degree_normalize_adj_tensor</span><span class="p">(</span><span class="n">adj</span><span
        class="p">,</span> <span class="n">sparse</span><span class="o">=</span><span class="kc">True</span><span
        class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;degree_normalize_adj_tensor.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">device</span> <span class="o">=</span> <span class="n">adj</span><span class="o">.</span><span
            class="n">device</span>
    <span class="k">if</span> <span class="n">sparse</span><span class="p">:</span>
        <span class="c1"># return  degree_normalize_sparse_tensor(adj)</span>
        <span class="n">adj</span> <span class="o">=</span> <span class="n">to_scipy</span><span class="p">(</span><span
            class="n">adj</span><span class="p">)</span>
        <span class="n">mx</span> <span class="o">=</span> <span class="n">degree_normalize_adj</span><span
            class="p">(</span><span class="n">adj</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sparse_mx_to_torch_sparse_tensor</span><span
            class="p">(</span><span class="n">mx</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span
            class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mx</span> <span class="o">=</span> <span class="n">adj</span> <span class="o">+</span> <span
            class="n">torch</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span
            class="n">adj</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span
            class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span
            class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">rowsum</span> <span class="o">=</span> <span class="n">mx</span><span class="o">.</span><span
            class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">r_inv</span> <span class="o">=</span> <span class="n">rowsum</span><span class="o">.</span><span
            class="n">pow</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span
            class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">r_inv</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span
            class="n">isinf</span><span class="p">(</span><span class="n">r_inv</span><span class="p">)]</span> <span
            class="o">=</span> <span class="mf">0.</span>
        <span class="n">r_mat_inv</span> <span class="o">=</span> <span class="n">torch</span><span
            class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">r_inv</span><span
            class="p">)</span>
        <span class="n">mx</span> <span class="o">=</span> <span class="n">r_mat_inv</span> <span
            class="o">@</span> <span class="n">mx</span>
    <span class="k">return</span> <span class="n">mx</span></div>


<div class="viewcode-block" id="accuracy"><a class="viewcode-back"
                                             href="../../source/graphslim.html#graphslim.utils.accuracy">[docs]</a><span
        class="k">def</span> <span class="nf">accuracy</span><span class="p">(</span><span class="n">output</span><span
        class="p">,</span> <span class="n">labels</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return accuracy of output compared to labels.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    output : torch.Tensor</span>
<span class="sd">        output from model</span>
<span class="sd">    labels : torch.Tensor or numpy.array</span>
<span class="sd">        node labels</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        accuracy</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span
            class="n">labels</span><span class="p">,</span> <span class="s1">&#39;__len__&#39;</span><span
            class="p">):</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span
            class="n">labels</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">labels</span><span
            class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">torch</span><span
            class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span
            class="n">LongTensor</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
    <span class="n">preds</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span
            class="n">max</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span
            class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">type_as</span><span
            class="p">(</span><span class="n">labels</span><span class="p">)</span>
    <span class="n">correct</span> <span class="o">=</span> <span class="n">preds</span><span class="o">.</span><span
            class="n">eq</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span><span
            class="o">.</span><span class="n">double</span><span class="p">()</span>
    <span class="n">correct</span> <span class="o">=</span> <span class="n">correct</span><span class="o">.</span><span
            class="n">sum</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">correct</span> <span class="o">/</span> <span
            class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span></div>


<div class="viewcode-block" id="loss_acc"><a class="viewcode-back"
                                             href="../../source/graphslim.html#graphslim.utils.loss_acc">[docs]</a><span
        class="k">def</span> <span class="nf">loss_acc</span><span class="p">(</span><span class="n">output</span><span
        class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">targets</span><span
        class="p">,</span> <span class="n">avg_loss</span><span class="o">=</span><span class="kc">True</span><span
        class="p">):</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">labels</span><span
            class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">torch</span><span
            class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span
            class="n">LongTensor</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
    <span class="n">preds</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span
            class="n">max</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span
            class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">type_as</span><span
            class="p">(</span><span class="n">labels</span><span class="p">)</span>
    <span class="n">correct</span> <span class="o">=</span> <span class="n">preds</span><span class="o">.</span><span
            class="n">eq</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span><span
            class="o">.</span><span class="n">double</span><span class="p">()[</span><span class="n">targets</span><span
            class="p">]</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span
            class="n">nll_loss</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span
            class="n">targets</span><span class="p">],</span> <span class="n">labels</span><span class="p">[</span><span
            class="n">targets</span><span class="p">],</span> <span class="n">reduction</span><span
            class="o">=</span><span class="s1">&#39;mean&#39;</span> <span class="k">if</span> <span
            class="n">avg_loss</span> <span class="k">else</span> <span class="s1">&#39;none&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">avg_loss</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">loss</span><span class="p">,</span> <span class="n">correct</span><span
            class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span
            class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">loss</span><span class="p">,</span> <span
            class="n">correct</span></div>
    <span class="c1"># correct = correct.sum()</span>
    <span class="c1"># return loss, correct / len(labels)</span>


<div class="viewcode-block" id="get_perf"><a class="viewcode-back"
                                             href="../../source/graphslim.html#graphslim.utils.get_perf">[docs]</a><span
        class="k">def</span> <span class="nf">get_perf</span><span class="p">(</span><span class="n">output</span><span
        class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">mask</span><span
        class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span
        class="p">):</span>
<span class="w">    </span><span
            class="sd">&quot;&quot;&quot;evalute performance for test masked data&quot;&quot;&quot;</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span
            class="n">nll_loss</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span
            class="n">mask</span><span class="p">],</span> <span class="n">labels</span><span class="p">[</span><span
            class="n">mask</span><span class="p">])</span>
    <span class="n">acc</span> <span class="o">=</span> <span class="n">accuracy</span><span class="p">(</span><span
            class="n">output</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span
            class="n">labels</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;loss= </span><span
            class="si">{:.4f}</span><span class="s2">&quot;</span><span class="o">.</span><span
            class="n">format</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span
            class="n">item</span><span class="p">()),</span>
              <span class="s2">&quot;accuracy= </span><span class="si">{:.4f}</span><span class="s2">&quot;</span><span
            class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">acc</span><span
            class="o">.</span><span class="n">item</span><span class="p">()))</span>
    <span class="k">return</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span
            class="p">(),</span> <span class="n">acc</span><span class="o">.</span><span class="n">item</span><span
            class="p">()</span></div>


<div class="viewcode-block" id="classification_margin"><a class="viewcode-back"
                                                          href="../../source/graphslim.html#graphslim.utils.classification_margin">[docs]</a><span
        class="k">def</span> <span class="nf">classification_margin</span><span class="p">(</span><span
        class="n">output</span><span class="p">,</span> <span class="n">true_label</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate classification margin for outputs.</span>
<span class="sd">    `probs_true_label - probs_best_second_class`</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    output: torch.Tensor</span>
<span class="sd">        output vector (1 dimension)</span>
<span class="sd">    true_label: int</span>
<span class="sd">        true label for this node</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list</span>
<span class="sd">        classification margin for this node</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">probs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span
            class="n">exp</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
    <span class="n">probs_true_label</span> <span class="o">=</span> <span class="n">probs</span><span
            class="p">[</span><span class="n">true_label</span><span class="p">]</span><span class="o">.</span><span
            class="n">clone</span><span class="p">()</span>
    <span class="n">probs</span><span class="p">[</span><span class="n">true_label</span><span class="p">]</span> <span
            class="o">=</span> <span class="mi">0</span>
    <span class="n">probs_best_second_class</span> <span class="o">=</span> <span class="n">probs</span><span class="p">[</span><span
            class="n">probs</span><span class="o">.</span><span class="n">argmax</span><span class="p">()]</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">probs_true_label</span> <span
            class="o">-</span> <span class="n">probs_best_second_class</span><span class="p">)</span><span
            class="o">.</span><span class="n">item</span><span class="p">()</span></div>


<div class="viewcode-block" id="sparse_mx_to_torch_sparse_tensor"><a class="viewcode-back"
                                                                     href="../../source/graphslim.html#graphslim.utils.sparse_mx_to_torch_sparse_tensor">[docs]</a><span
        class="k">def</span> <span class="nf">sparse_mx_to_torch_sparse_tensor</span><span class="p">(</span><span
        class="n">sparse_mx</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert a scipy sparse matrix to a torch sparse tensor.&quot;&quot;&quot;</span>
    <span class="n">sparse_mx</span> <span class="o">=</span> <span class="n">sparse_mx</span><span
            class="o">.</span><span class="n">tocoo</span><span class="p">()</span><span class="o">.</span><span
            class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span
            class="n">float32</span><span class="p">)</span>
    <span class="n">sparserow</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span
            class="n">LongTensor</span><span class="p">(</span><span class="n">sparse_mx</span><span
            class="o">.</span><span class="n">row</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span
            class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">sparsecol</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span
            class="n">LongTensor</span><span class="p">(</span><span class="n">sparse_mx</span><span
            class="o">.</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span
            class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">sparseconcat</span> <span class="o">=</span> <span class="n">torch</span><span
            class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">sparserow</span><span
            class="p">,</span> <span class="n">sparsecol</span><span class="p">),</span> <span class="mi">1</span><span
            class="p">)</span>
    <span class="n">sparsedata</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span
            class="n">FloatTensor</span><span class="p">(</span><span class="n">sparse_mx</span><span class="o">.</span><span
            class="n">data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span
            class="n">sparse_coo_tensor</span><span class="p">(</span><span class="n">sparseconcat</span><span
            class="o">.</span><span class="n">t</span><span class="p">(),</span> <span class="n">sparsedata</span><span
            class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span
            class="p">(</span><span class="n">sparse_mx</span><span class="o">.</span><span class="n">shape</span><span
            class="p">))</span></div>


<span class="c1"># slower version....</span>
<span class="c1"># sparse_mx = sparse_mx.tocoo().astype(np.float32)</span>
<span class="c1"># indices = torch.from_numpy(</span>
<span class="c1">#     np.vstack((sparse_mx.row, sparse_mx.col)).astype(np.int64))</span>
<span class="c1"># values = torch.from_numpy(sparse_mx.data)</span>
<span class="c1"># shape = torch.Size(sparse_mx.shape)</span>
<span class="c1"># return torch.sparse.FloatTensor(indices, values, shape)</span>


<div class="viewcode-block" id="to_scipy"><a class="viewcode-back"
                                             href="../../source/graphslim.html#graphslim.utils.to_scipy">[docs]</a><span
        class="k">def</span> <span class="nf">to_scipy</span><span class="p">(</span><span class="n">tensor</span><span
        class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert a dense/sparse tensor to scipy matrix&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">is_sparse_tensor</span><span class="p">(</span><span
            class="n">tensor</span><span class="p">):</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">tensor</span><span
            class="o">.</span><span class="n">_values</span><span class="p">()</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">tensor</span><span
            class="o">.</span><span class="n">_indices</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">sp</span><span class="o">.</span><span class="n">csr_matrix</span><span
            class="p">((</span><span class="n">values</span><span class="o">.</span><span class="n">cpu</span><span
            class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span
            class="n">indices</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span
            class="o">.</span><span class="n">numpy</span><span class="p">()),</span> <span class="n">shape</span><span
            class="o">=</span><span class="n">tensor</span><span class="o">.</span><span class="n">shape</span><span
            class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">tensor</span><span
            class="o">.</span><span class="n">nonzero</span><span class="p">()</span><span class="o">.</span><span
            class="n">t</span><span class="p">()</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">tensor</span><span
            class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span
            class="p">],</span> <span class="n">indices</span><span class="p">[</span><span class="mi">1</span><span
            class="p">]]</span>
        <span class="k">return</span> <span class="n">sp</span><span class="o">.</span><span class="n">csr_matrix</span><span
            class="p">((</span><span class="n">values</span><span class="o">.</span><span class="n">cpu</span><span
            class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span
            class="n">indices</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span
            class="o">.</span><span class="n">numpy</span><span class="p">()),</span> <span class="n">shape</span><span
            class="o">=</span><span class="n">tensor</span><span class="o">.</span><span class="n">shape</span><span
            class="p">)</span></div>


<div class="viewcode-block" id="is_sparse_tensor"><a class="viewcode-back"
                                                     href="../../source/graphslim.html#graphslim.utils.is_sparse_tensor">[docs]</a><span
        class="k">def</span> <span class="nf">is_sparse_tensor</span><span class="p">(</span><span
        class="n">tensor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if a tensor is sparse tensor.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tensor : torch.Tensor</span>
<span class="sd">        given tensor</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool</span>
<span class="sd">        whether a tensor is sparse tensor</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># if hasattr(tensor, &#39;nnz&#39;):</span>
    <span class="k">if</span> <span class="n">tensor</span><span class="o">.</span><span class="n">layout</span> <span
            class="o">==</span> <span class="n">torch</span><span class="o">.</span><span
            class="n">sparse_coo</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="get_train_val_test"><a class="viewcode-back"
                                                       href="../../source/graphslim.html#graphslim.utils.get_train_val_test">[docs]</a><span
        class="k">def</span> <span class="nf">get_train_val_test</span><span class="p">(</span><span
        class="n">nnodes</span><span class="p">,</span> <span class="n">val_size</span><span class="o">=</span><span
        class="mf">0.1</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span
        class="mf">0.8</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span
        class="kc">None</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span
        class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This setting follows nettack/mettack, where we split the nodes</span>
<span class="sd">    into 10% training, 10% validation and 80% testing data</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    nnodes : int</span>
<span class="sd">        number of nodes in total</span>
<span class="sd">    val_size : float</span>
<span class="sd">        size of validation set</span>
<span class="sd">    test_size : float</span>
<span class="sd">        size of test set</span>
<span class="sd">    stratify :</span>
<span class="sd">        data is expected to split in a stratified fashion. So stratify should be labels.</span>
<span class="sd">    seed : int or None</span>
<span class="sd">        random seed</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    idx_train :</span>
<span class="sd">        node training indices</span>
<span class="sd">    idx_val :</span>
<span class="sd">        node validation indices</span>
<span class="sd">    idx_test :</span>
<span class="sd">        node test indices</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">assert</span> <span class="n">stratify</span> <span class="ow">is</span> <span class="ow">not</span> <span
            class="kc">None</span><span class="p">,</span> <span class="s1">&#39;stratify cannot be None!&#39;</span>

    <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span
            class="kc">None</span><span class="p">:</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span
            class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span
            class="n">arange</span><span class="p">(</span><span class="n">nnodes</span><span class="p">)</span>
    <span class="n">train_size</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span
            class="n">val_size</span> <span class="o">-</span> <span class="n">test_size</span>
    <span class="n">idx_train_and_val</span><span class="p">,</span> <span class="n">idx_test</span> <span
            class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">idx</span><span
            class="p">,</span>
                                                   <span class="n">random_state</span><span class="o">=</span><span
            class="kc">None</span><span class="p">,</span>
                                                   <span class="n">train_size</span><span class="o">=</span><span
            class="n">train_size</span> <span class="o">+</span> <span class="n">val_size</span><span class="p">,</span>
                                                   <span class="n">test_size</span><span class="o">=</span><span
            class="n">test_size</span><span class="p">,</span>
                                                   <span class="n">stratify</span><span class="o">=</span><span
            class="n">stratify</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">stratify</span> <span class="ow">is</span> <span
            class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">stratify</span> <span class="o">=</span> <span class="n">stratify</span><span class="p">[</span><span
            class="n">idx_train_and_val</span><span class="p">]</span>

    <span class="n">idx_train</span><span class="p">,</span> <span class="n">idx_val</span> <span
            class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">idx_train_and_val</span><span
            class="p">,</span>
                                          <span class="n">random_state</span><span class="o">=</span><span class="kc">None</span><span
            class="p">,</span>
                                          <span class="n">train_size</span><span class="o">=</span><span
            class="p">(</span><span class="n">train_size</span> <span class="o">/</span> <span class="p">(</span><span
            class="n">train_size</span> <span class="o">+</span> <span class="n">val_size</span><span
            class="p">)),</span>
                                          <span class="n">test_size</span><span class="o">=</span><span
            class="p">(</span><span class="n">val_size</span> <span class="o">/</span> <span class="p">(</span><span
            class="n">train_size</span> <span class="o">+</span> <span class="n">val_size</span><span
            class="p">)),</span>
                                          <span class="n">stratify</span><span class="o">=</span><span class="n">stratify</span><span
            class="p">)</span>

    <span class="k">return</span> <span class="n">idx_train</span><span class="p">,</span> <span
            class="n">idx_val</span><span class="p">,</span> <span class="n">idx_test</span></div>


<div class="viewcode-block" id="get_train_test"><a class="viewcode-back"
                                                   href="../../source/graphslim.html#graphslim.utils.get_train_test">[docs]</a><span
        class="k">def</span> <span class="nf">get_train_test</span><span class="p">(</span><span class="n">nnodes</span><span
        class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.8</span><span
        class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="kc">None</span><span
        class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span
        class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This function returns training and test set without validation.</span>
<span class="sd">    It can be used for settings of different label rates.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    nnodes : int</span>
<span class="sd">        number of nodes in total</span>
<span class="sd">    test_size : float</span>
<span class="sd">        size of test set</span>
<span class="sd">    stratify :</span>
<span class="sd">        data is expected to split in a stratified fashion. So stratify should be labels.</span>
<span class="sd">    seed : int or None</span>
<span class="sd">        random seed</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    idx_train :</span>
<span class="sd">        node training indices</span>
<span class="sd">    idx_test :</span>
<span class="sd">        node test indices</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">stratify</span> <span class="ow">is</span> <span class="ow">not</span> <span
            class="kc">None</span><span class="p">,</span> <span class="s1">&#39;stratify cannot be None!&#39;</span>

    <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span
            class="kc">None</span><span class="p">:</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span
            class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span
            class="n">arange</span><span class="p">(</span><span class="n">nnodes</span><span class="p">)</span>
    <span class="n">train_size</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span
            class="n">test_size</span>
    <span class="n">idx_train</span><span class="p">,</span> <span class="n">idx_test</span> <span
            class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">idx</span><span
            class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span
            class="kc">None</span><span class="p">,</span>
                                           <span class="n">train_size</span><span class="o">=</span><span class="n">train_size</span><span
            class="p">,</span>
                                           <span class="n">test_size</span><span class="o">=</span><span class="n">test_size</span><span
            class="p">,</span>
                                           <span class="n">stratify</span><span class="o">=</span><span class="n">stratify</span><span
            class="p">)</span>

    <span class="k">return</span> <span class="n">idx_train</span><span class="p">,</span> <span
            class="n">idx_test</span></div>


<div class="viewcode-block" id="get_train_val_test_gcn"><a class="viewcode-back"
                                                           href="../../source/graphslim.html#graphslim.utils.get_train_val_test_gcn">[docs]</a><span
        class="k">def</span> <span class="nf">get_train_val_test_gcn</span><span class="p">(</span><span class="n">labels</span><span
        class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span
        class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This setting follows gcn, where we randomly sample 20 instances for each class</span>
<span class="sd">    as training data, 500 instances as validation data, 1000 instances as test data.</span>
<span class="sd">    Note here we are not using fixed splits. When random seed changes, the splits</span>
<span class="sd">    will also change.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    labels : numpy.array</span>
<span class="sd">        node labels</span>
<span class="sd">    seed : int or None</span>
<span class="sd">        random seed</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    idx_train :</span>
<span class="sd">        node training indices</span>
<span class="sd">    idx_val :</span>
<span class="sd">        node validation indices</span>
<span class="sd">    idx_test :</span>
<span class="sd">        node test indices</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span
            class="kc">None</span><span class="p">:</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span
            class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span
            class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span
            class="n">labels</span><span class="p">))</span>
    <span class="n">nclass</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span
            class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">idx_train</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">idx_unlabeled</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span
            class="p">(</span><span class="n">nclass</span><span class="p">):</span>
        <span class="n">labels_i</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span
            class="n">labels</span> <span class="o">==</span> <span class="n">i</span><span class="p">]</span>
        <span class="n">labels_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span
            class="n">random</span><span class="o">.</span><span class="n">permutation</span><span
            class="p">(</span><span class="n">labels_i</span><span class="p">)</span>
        <span class="n">idx_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span
            class="n">hstack</span><span class="p">((</span><span class="n">idx_train</span><span
            class="p">,</span> <span class="n">labels_i</span><span class="p">[:</span> <span class="mi">20</span><span
            class="p">]))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span
            class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
        <span class="n">idx_unlabeled</span> <span class="o">=</span> <span class="n">np</span><span
            class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">idx_unlabeled</span><span
            class="p">,</span> <span class="n">labels_i</span><span class="p">[</span><span class="mi">20</span><span
            class="p">:]))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span
            class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>

    <span class="n">idx_unlabeled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span
            class="n">random</span><span class="o">.</span><span class="n">permutation</span><span
            class="p">(</span><span class="n">idx_unlabeled</span><span class="p">)</span>
    <span class="n">idx_val</span> <span class="o">=</span> <span class="n">idx_unlabeled</span><span
            class="p">[:</span> <span class="mi">500</span><span class="p">]</span>
    <span class="n">idx_test</span> <span class="o">=</span> <span class="n">idx_unlabeled</span><span
            class="p">[</span><span class="mi">500</span><span class="p">:</span> <span class="mi">1500</span><span
            class="p">]</span>
    <span class="k">return</span> <span class="n">idx_train</span><span class="p">,</span> <span
            class="n">idx_val</span><span class="p">,</span> <span class="n">idx_test</span></div>


<div class="viewcode-block" id="get_train_test_labelrate"><a class="viewcode-back"
                                                             href="../../source/graphslim.html#graphslim.utils.get_train_test_labelrate">[docs]</a><span
        class="k">def</span> <span class="nf">get_train_test_labelrate</span><span class="p">(</span><span class="n">labels</span><span
        class="p">,</span> <span class="n">label_rate</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get train test according to given label rate.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nclass</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span
            class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">train_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span
            class="nb">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span
            class="n">labels</span><span class="p">)</span> <span class="o">*</span> <span
            class="n">label_rate</span> <span class="o">/</span> <span class="n">nclass</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== train_size = </span><span
            class="si">%s</span><span class="s2"> ===&quot;</span> <span class="o">%</span> <span
            class="n">train_size</span><span class="p">)</span>
    <span class="n">idx_train</span><span class="p">,</span> <span class="n">idx_val</span><span
            class="p">,</span> <span class="n">idx_test</span> <span class="o">=</span> <span class="n">get_splits_each_class</span><span
            class="p">(</span><span class="n">labels</span><span class="p">,</span> <span
            class="n">train_size</span><span class="o">=</span><span class="n">train_size</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">idx_train</span><span class="p">,</span> <span
            class="n">idx_test</span></div>


<div class="viewcode-block" id="get_splits_each_class"><a class="viewcode-back"
                                                          href="../../source/graphslim.html#graphslim.utils.get_splits_each_class">[docs]</a><span
        class="k">def</span> <span class="nf">get_splits_each_class</span><span class="p">(</span><span
        class="n">labels</span><span class="p">,</span> <span class="n">train_size</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;We randomly sample n instances for class, where n = train_size.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span
            class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span
            class="n">labels</span><span class="p">))</span>
    <span class="n">nclass</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span
            class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">idx_train</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">idx_val</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">idx_test</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span
            class="p">(</span><span class="n">nclass</span><span class="p">):</span>
        <span class="n">labels_i</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span
            class="n">labels</span> <span class="o">==</span> <span class="n">i</span><span class="p">]</span>
        <span class="n">labels_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span
            class="n">random</span><span class="o">.</span><span class="n">permutation</span><span
            class="p">(</span><span class="n">labels_i</span><span class="p">)</span>
        <span class="n">idx_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span
            class="n">hstack</span><span class="p">((</span><span class="n">idx_train</span><span
            class="p">,</span> <span class="n">labels_i</span><span class="p">[:</span> <span
            class="n">train_size</span><span class="p">]))</span><span class="o">.</span><span
            class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span
            class="n">int</span><span class="p">)</span>
        <span class="n">idx_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span
            class="n">hstack</span><span class="p">((</span><span class="n">idx_val</span><span class="p">,</span> <span
            class="n">labels_i</span><span class="p">[</span><span class="n">train_size</span><span
            class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">train_size</span><span
            class="p">]))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span
            class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
        <span class="n">idx_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span
            class="n">hstack</span><span class="p">((</span><span class="n">idx_test</span><span
            class="p">,</span> <span class="n">labels_i</span><span class="p">[</span><span class="mi">2</span> <span
            class="o">*</span> <span class="n">train_size</span><span class="p">:]))</span><span class="o">.</span><span
            class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span
            class="n">int</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span
            class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">idx_train</span><span
            class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span
            class="o">.</span><span class="n">permutation</span><span class="p">(</span><span
            class="n">idx_val</span><span class="p">),</span> \
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span
            class="n">permutation</span><span class="p">(</span><span class="n">idx_test</span><span class="p">)</span></div>


<div class="viewcode-block" id="unravel_index"><a class="viewcode-back"
                                                  href="../../source/graphslim.html#graphslim.utils.unravel_index">[docs]</a><span
        class="k">def</span> <span class="nf">unravel_index</span><span class="p">(</span><span
        class="n">index</span><span class="p">,</span> <span class="n">array_shape</span><span class="p">):</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span
            class="n">div</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span
            class="n">array_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span
            class="n">rounding_mode</span><span class="o">=</span><span class="s1">&#39;trunc&#39;</span><span
            class="p">)</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="n">index</span> <span class="o">%</span> <span
            class="n">array_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span></div>


<div class="viewcode-block" id="get_degree_squence"><a class="viewcode-back"
                                                       href="../../source/graphslim.html#graphslim.utils.get_degree_squence">[docs]</a><span
        class="k">def</span> <span class="nf">get_degree_squence</span><span class="p">(</span><span
        class="n">adj</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">adj</span><span class="o">.</span><span class="n">sum</span><span
            class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ts</span><span class="o">.</span><span class="n">sum</span><span
            class="p">(</span><span class="n">adj</span><span class="p">,</span> <span class="n">dim</span><span
            class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to_dense</span><span
            class="p">()</span></div>


<div class="viewcode-block" id="degree_sequence_log_likelihood"><a class="viewcode-back"
                                                                   href="../../source/graphslim.html#graphslim.utils.degree_sequence_log_likelihood">[docs]</a><span
        class="k">def</span> <span class="nf">degree_sequence_log_likelihood</span><span class="p">(</span><span
        class="n">degree_sequence</span><span class="p">,</span> <span class="n">d_min</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the (maximum) log likelihood of the Powerlaw distribution fit on a degree distribution.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Determine which degrees are to be considered, i.e. &gt;= d_min.</span>
    <span class="n">D_G</span> <span class="o">=</span> <span class="n">degree_sequence</span><span
            class="p">[(</span><span class="n">degree_sequence</span> <span class="o">&gt;=</span> <span
            class="n">d_min</span><span class="o">.</span><span class="n">item</span><span class="p">())]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">sum_log_degrees</span> <span class="o">=</span> <span class="n">torch</span><span
            class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">D_G</span><span
            class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">sum_log_degrees</span> <span class="o">=</span> <span class="n">np</span><span
            class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">D_G</span><span
            class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span
            class="n">D_G</span><span class="p">)</span>

    <span class="n">alpha</span> <span class="o">=</span> <span class="n">compute_alpha</span><span
            class="p">(</span><span class="n">n</span><span class="p">,</span> <span
            class="n">sum_log_degrees</span><span class="p">,</span> <span class="n">d_min</span><span
            class="p">)</span>
    <span class="n">ll</span> <span class="o">=</span> <span class="n">compute_log_likelihood</span><span
            class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">alpha</span><span
            class="p">,</span> <span class="n">sum_log_degrees</span><span class="p">,</span> <span
            class="n">d_min</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ll</span><span class="p">,</span> <span class="n">alpha</span><span
            class="p">,</span> <span class="n">n</span><span class="p">,</span> <span
            class="n">sum_log_degrees</span></div>


<div class="viewcode-block" id="updated_log_likelihood_for_edge_changes"><a class="viewcode-back"
                                                                            href="../../source/graphslim.html#graphslim.utils.updated_log_likelihood_for_edge_changes">[docs]</a><span
        class="k">def</span> <span class="nf">updated_log_likelihood_for_edge_changes</span><span
        class="p">(</span><span class="n">node_pairs</span><span class="p">,</span> <span
        class="n">adjacency_matrix</span><span class="p">,</span> <span class="n">d_min</span><span class="p">):</span>
<span class="w">    </span><span
            class="sd">&quot;&quot;&quot; Adopted from https://github.com/danielzuegner/nettack</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># For each node pair find out whether there is an edge or not in the input adjacency matrix.</span>

    <span class="n">edge_entries_before</span> <span class="o">=</span> <span class="n">adjacency_matrix</span><span
            class="p">[</span><span class="n">node_pairs</span><span class="o">.</span><span class="n">T</span><span
            class="p">]</span>
    <span class="n">degree_sequence</span> <span class="o">=</span> <span class="n">adjacency_matrix</span><span
            class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span
            class="p">)</span>
    <span class="n">D_G</span> <span class="o">=</span> <span class="n">degree_sequence</span><span
            class="p">[</span><span class="n">degree_sequence</span> <span class="o">&gt;=</span> <span
            class="n">d_min</span><span class="o">.</span><span class="n">item</span><span class="p">()]</span>
    <span class="n">sum_log_degrees</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span
            class="n">log</span><span class="p">(</span><span class="n">D_G</span><span class="p">)</span><span
            class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span
            class="n">D_G</span><span class="p">)</span>
    <span class="n">deltas</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span> <span
            class="o">*</span> <span class="n">edge_entries_before</span> <span class="o">+</span> <span
            class="mi">1</span>
    <span class="n">d_edges_before</span> <span class="o">=</span> <span class="n">degree_sequence</span><span
            class="p">[</span><span class="n">node_pairs</span><span class="p">]</span>

    <span class="n">d_edges_after</span> <span class="o">=</span> <span class="n">degree_sequence</span><span class="p">[</span><span
            class="n">node_pairs</span><span class="p">]</span> <span class="o">+</span> <span
            class="n">deltas</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>

    <span class="c1"># Sum the log of the degrees after the potential changes which are &gt;= d_min</span>
    <span class="n">sum_log_degrees_after</span><span class="p">,</span> <span class="n">new_n</span> <span
            class="o">=</span> <span class="n">update_sum_log_degrees</span><span class="p">(</span><span class="n">sum_log_degrees</span><span
            class="p">,</span> <span class="n">n</span><span class="p">,</span> <span
            class="n">d_edges_before</span><span class="p">,</span> <span class="n">d_edges_after</span><span class="p">,</span> <span
            class="n">d_min</span><span class="p">)</span>
    <span class="c1"># Updated estimates of the Powerlaw exponents</span>
    <span class="n">new_alpha</span> <span class="o">=</span> <span class="n">compute_alpha</span><span
            class="p">(</span><span class="n">new_n</span><span class="p">,</span> <span
            class="n">sum_log_degrees_after</span><span class="p">,</span> <span class="n">d_min</span><span
            class="p">)</span>
    <span class="c1"># Updated log likelihood values for the Powerlaw distributions</span>
    <span class="n">new_ll</span> <span class="o">=</span> <span class="n">compute_log_likelihood</span><span class="p">(</span><span
            class="n">new_n</span><span class="p">,</span> <span class="n">new_alpha</span><span
            class="p">,</span> <span class="n">sum_log_degrees_after</span><span class="p">,</span> <span class="n">d_min</span><span
            class="p">)</span>
    <span class="k">return</span> <span class="n">new_ll</span><span class="p">,</span> <span class="n">new_alpha</span><span
            class="p">,</span> <span class="n">new_n</span><span class="p">,</span> <span class="n">sum_log_degrees_after</span></div>


<div class="viewcode-block" id="update_sum_log_degrees"><a class="viewcode-back"
                                                           href="../../source/graphslim.html#graphslim.utils.update_sum_log_degrees">[docs]</a><span
        class="k">def</span> <span class="nf">update_sum_log_degrees</span><span class="p">(</span><span class="n">sum_log_degrees_before</span><span
        class="p">,</span> <span class="n">n_old</span><span class="p">,</span> <span class="n">d_old</span><span
        class="p">,</span> <span class="n">d_new</span><span class="p">,</span> <span class="n">d_min</span><span
        class="p">):</span>
    <span class="c1"># Find out whether the degrees before and after the change are above the threshold d_min.</span>
    <span class="n">old_in_range</span> <span class="o">=</span> <span class="n">d_old</span> <span
            class="o">&gt;=</span> <span class="n">d_min</span>
    <span class="n">new_in_range</span> <span class="o">=</span> <span class="n">d_new</span> <span
            class="o">&gt;=</span> <span class="n">d_min</span>
    <span class="n">d_old_in_range</span> <span class="o">=</span> <span class="n">d_old</span> <span class="o">*</span> <span
            class="n">old_in_range</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
    <span class="n">d_new_in_range</span> <span class="o">=</span> <span class="n">d_new</span> <span class="o">*</span> <span
            class="n">new_in_range</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>

    <span class="c1"># Update the sum by subtracting the old values and then adding the updated logs of the degrees.</span>
    <span class="n">sum_log_degrees_after</span> <span class="o">=</span> <span class="n">sum_log_degrees_before</span> <span
            class="o">-</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span
            class="n">log</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span
            class="n">clamp</span><span class="p">(</span><span class="n">d_old_in_range</span><span class="p">,</span> <span
            class="nb">min</span><span class="o">=</span><span class="mi">1</span><span class="p">)))</span><span
            class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span
            class="p">)</span> \
                            <span class="o">+</span> <span class="p">(</span><span class="n">torch</span><span
            class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">torch</span><span
            class="o">.</span><span class="n">clamp</span><span class="p">(</span><span
            class="n">d_new_in_range</span><span class="p">,</span> <span class="nb">min</span><span
            class="o">=</span><span class="mi">1</span><span class="p">)))</span><span class="o">.</span><span
            class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Update the number of degrees &gt;= d_min</span>

    <span class="n">new_n</span> <span class="o">=</span> <span class="n">n_old</span> <span class="o">-</span> <span
            class="p">(</span><span class="n">old_in_range</span> <span class="o">!=</span> <span
            class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span
            class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span
            class="p">(</span><span class="n">new_in_range</span> <span class="o">!=</span> <span
            class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span
            class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">new_n</span> <span class="o">=</span> <span class="n">new_n</span><span class="o">.</span><span
            class="n">float</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">sum_log_degrees_after</span><span class="p">,</span> <span class="n">new_n</span></div>


<div class="viewcode-block" id="compute_alpha"><a class="viewcode-back"
                                                  href="../../source/graphslim.html#graphslim.utils.compute_alpha">[docs]</a><span
        class="k">def</span> <span class="nf">compute_alpha</span><span class="p">(</span><span class="n">n</span><span
        class="p">,</span> <span class="n">sum_log_degrees</span><span class="p">,</span> <span
        class="n">d_min</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span
            class="n">n</span> <span class="o">/</span> <span class="p">(</span><span
            class="n">sum_log_degrees</span> <span class="o">-</span> <span class="n">n</span> <span class="o">*</span> <span
            class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span
            class="n">d_min</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span
            class="n">n</span> <span class="o">/</span> <span class="p">(</span><span
            class="n">sum_log_degrees</span> <span class="o">-</span> <span class="n">n</span> <span class="o">*</span> <span
            class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span
            class="n">d_min</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">alpha</span></div>


<div class="viewcode-block" id="compute_log_likelihood"><a class="viewcode-back"
                                                           href="../../source/graphslim.html#graphslim.utils.compute_log_likelihood">[docs]</a><span
        class="k">def</span> <span class="nf">compute_log_likelihood</span><span class="p">(</span><span
        class="n">n</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">sum_log_degrees</span><span
        class="p">,</span> <span class="n">d_min</span><span class="p">):</span>
    <span class="c1"># Log likelihood under alpha</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ll</span> <span class="o">=</span> <span class="n">n</span> <span class="o">*</span> <span
            class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span
            class="n">alpha</span><span class="p">)</span> <span class="o">+</span> <span class="n">n</span> <span
            class="o">*</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">torch</span><span
            class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">d_min</span><span
            class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">alpha</span> <span
            class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span
            class="n">sum_log_degrees</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">ll</span> <span class="o">=</span> <span class="n">n</span> <span class="o">*</span> <span
            class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span
            class="n">alpha</span><span class="p">)</span> <span class="o">+</span> <span class="n">n</span> <span
            class="o">*</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">np</span><span
            class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">d_min</span><span
            class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">alpha</span> <span
            class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span
            class="n">sum_log_degrees</span>

    <span class="k">return</span> <span class="n">ll</span></div>


<div class="viewcode-block" id="ravel_multiple_indices"><a class="viewcode-back"
                                                           href="../../source/graphslim.html#graphslim.utils.ravel_multiple_indices">[docs]</a><span
        class="k">def</span> <span class="nf">ravel_multiple_indices</span><span class="p">(</span><span
        class="n">ixs</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span
        class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;Flattens&quot; multiple 2D input indices into indices on the flattened matrix, similar to np.ravel_multi_index.</span>
<span class="sd">    Does the same as ravel_index but for multiple indices at once.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ixs: array of ints shape (n, 2)</span>
<span class="sd">        The array of n indices that will be flattened.</span>

<span class="sd">    shape: list or tuple of ints of length 2</span>
<span class="sd">        The shape of the corresponding matrix.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    array of n ints between 0 and shape[0]*shape[1]-1</span>
<span class="sd">        The indices on the flattened matrix corresponding to the 2D input indices.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">reverse</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ixs</span><span class="p">[:,</span> <span
            class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">shape</span><span
            class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span
            class="n">ixs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">ixs</span><span class="p">[:,</span> <span class="mi">0</span><span
            class="p">]</span> <span class="o">*</span> <span class="n">shape</span><span class="p">[</span><span
            class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">ixs</span><span
            class="p">[:,</span> <span class="mi">1</span><span class="p">]</span></div>


<span class="c1"># def visualize(your_var):</span>
<span class="c1">#     &quot;&quot;&quot;visualize computation graph&quot;&quot;&quot;</span>
<span class="c1">#     from torchviz import make_dot</span>
<span class="c1">#     make_dot(your_var).view()</span>
<span class="c1">#</span>

<div class="viewcode-block" id="reshape_mx"><a class="viewcode-back"
                                               href="../../source/graphslim.html#graphslim.utils.reshape_mx">[docs]</a><span
        class="k">def</span> <span class="nf">reshape_mx</span><span class="p">(</span><span class="n">mx</span><span
        class="p">,</span> <span class="n">shape</span><span class="p">):</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="n">mx</span><span class="o">.</span><span
            class="n">nonzero</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">sp</span><span class="o">.</span><span
            class="n">csr_matrix</span><span class="p">((</span><span class="n">mx</span><span class="o">.</span><span
            class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">indices</span><span
            class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">indices</span><span
            class="p">[</span><span class="mi">1</span><span class="p">])),</span> <span class="n">shape</span><span
            class="o">=</span><span class="n">shape</span><span class="p">)</span></div>


<div class="viewcode-block" id="add_mask"><a class="viewcode-back"
                                             href="../../source/graphslim.html#graphslim.utils.add_mask">[docs]</a><span
        class="k">def</span> <span class="nf">add_mask</span><span class="p">(</span><span class="n">data</span><span
        class="p">,</span> <span class="n">dataset</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;data: ogb-arxiv pyg data format&quot;&quot;&quot;</span>
    <span class="c1"># for arxiv</span>
    <span class="n">split_idx</span> <span class="o">=</span> <span class="n">dataset</span><span
            class="o">.</span><span class="n">get_idx_split</span><span class="p">()</span>
    <span class="n">train_idx</span><span class="p">,</span> <span class="n">valid_idx</span><span
            class="p">,</span> <span class="n">test_idx</span> <span class="o">=</span> <span class="n">split_idx</span><span
            class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">],</span> <span class="n">split_idx</span><span
            class="p">[</span><span class="s2">&quot;valid&quot;</span><span class="p">],</span> <span class="n">split_idx</span><span
            class="p">[</span><span class="s2">&quot;test&quot;</span><span class="p">]</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span
            class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span
            class="mi">0</span><span class="p">]</span>
    <span class="n">data</span><span class="o">.</span><span class="n">train_mask</span> <span class="o">=</span> <span
            class="n">index_to_mask</span><span class="p">(</span><span class="n">train_idx</span><span
            class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="n">data</span><span class="o">.</span><span class="n">val_mask</span> <span class="o">=</span> <span
            class="n">index_to_mask</span><span class="p">(</span><span class="n">valid_idx</span><span
            class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="n">data</span><span class="o">.</span><span class="n">test_mask</span> <span class="o">=</span> <span
            class="n">index_to_mask</span><span class="p">(</span><span class="n">test_idx</span><span
            class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="n">data</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span
            class="n">data</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span
            class="n">squeeze</span><span class="p">()</span></div>
    <span class="c1"># data.edge_index = to_undirected(data.edge_index, data.num_nodes)</span>


<div class="viewcode-block" id="index_to_mask"><a class="viewcode-back"
                                                  href="../../source/graphslim.html#graphslim.utils.index_to_mask">[docs]</a><span
        class="k">def</span> <span class="nf">index_to_mask</span><span class="p">(</span><span
        class="n">index</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span
            class="n">zeros</span><span class="p">((</span><span class="n">size</span><span class="p">,),</span> <span
            class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span
            class="n">bool</span><span class="p">)</span>
    <span class="n">mask</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span
            class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">mask</span></div>


<div class="viewcode-block" id="add_feature_noise"><a class="viewcode-back"
                                                      href="../../source/graphslim.html#graphslim.utils.add_feature_noise">[docs]</a><span
        class="k">def</span> <span class="nf">add_feature_noise</span><span class="p">(</span><span
        class="n">data</span><span class="p">,</span> <span class="n">noise_ratio</span><span class="p">,</span> <span
        class="n">seed</span><span class="p">):</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span
            class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">n</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">data</span><span
            class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span>
    <span class="c1"># noise = torch.normal(mean=torch.zeros(int(noise_ratio*n), d), std=1)</span>
    <span class="n">noise</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span
            class="n">FloatTensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span
            class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span
            class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span
            class="n">size</span><span class="o">=</span><span class="p">(</span><span class="nb">int</span><span
            class="p">(</span><span class="n">noise_ratio</span> <span class="o">*</span> <span class="n">n</span><span
            class="p">),</span> <span class="n">d</span><span class="p">)))</span><span class="o">.</span><span
            class="n">to</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span
            class="n">x</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span
            class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span
            class="n">random</span><span class="o">.</span><span class="n">permutation</span><span
            class="p">(</span><span class="n">indices</span><span class="p">)[:</span> <span class="nb">int</span><span
            class="p">(</span><span class="n">noise_ratio</span> <span class="o">*</span> <span class="n">n</span><span
            class="p">)]</span>
    <span class="n">delta_feat</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span
            class="n">zeros_like</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span
            class="n">x</span><span class="p">)</span>
    <span class="n">delta_feat</span><span class="p">[</span><span class="n">indices</span><span
            class="p">]</span> <span class="o">=</span> <span class="n">noise</span> <span class="o">-</span> <span
            class="n">data</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span
            class="n">indices</span><span class="p">]</span>
    <span class="n">data</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">indices</span><span
            class="p">]</span> <span class="o">=</span> <span class="n">noise</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span
            class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="n">mask</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span> <span
            class="o">=</span> <span class="mi">1</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span
            class="n">tensor</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span><span
            class="o">.</span><span class="n">bool</span><span class="p">()</span><span class="o">.</span><span
            class="n">to</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span
            class="n">x</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">delta_feat</span><span class="p">,</span> <span class="n">mask</span></div>


<div class="viewcode-block" id="add_feature_noise_test"><a class="viewcode-back"
                                                           href="../../source/graphslim.html#graphslim.utils.add_feature_noise_test">[docs]</a><span
        class="k">def</span> <span class="nf">add_feature_noise_test</span><span class="p">(</span><span
        class="n">data</span><span class="p">,</span> <span class="n">noise_ratio</span><span class="p">,</span> <span
        class="n">seed</span><span class="p">):</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span
            class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">n</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">data</span><span
            class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span
            class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="n">test_nodes</span> <span class="o">=</span> <span class="n">indices</span><span
            class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">test_mask</span><span
            class="o">.</span><span class="n">cpu</span><span class="p">()]</span>
    <span class="n">selected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span
            class="n">random</span><span class="o">.</span><span class="n">permutation</span><span
            class="p">(</span><span class="n">test_nodes</span><span class="p">)[:</span> <span
            class="nb">int</span><span class="p">(</span><span class="n">noise_ratio</span> <span
            class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_nodes</span><span
            class="p">))]</span>
    <span class="n">noise</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span
            class="n">FloatTensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span
            class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span
            class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span
            class="n">size</span><span class="o">=</span><span class="p">(</span><span class="nb">int</span><span
            class="p">(</span><span class="n">noise_ratio</span> <span class="o">*</span> <span
            class="nb">len</span><span class="p">(</span><span class="n">test_nodes</span><span
            class="p">)),</span> <span class="n">d</span><span class="p">)))</span>
    <span class="n">noise</span> <span class="o">=</span> <span class="n">noise</span><span class="o">.</span><span
            class="n">to</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span
            class="n">x</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

    <span class="n">delta_feat</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span
            class="n">zeros_like</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span
            class="n">x</span><span class="p">)</span>
    <span class="n">delta_feat</span><span class="p">[</span><span class="n">selected</span><span
            class="p">]</span> <span class="o">=</span> <span class="n">noise</span> <span class="o">-</span> <span
            class="n">data</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span
            class="n">selected</span><span class="p">]</span>
    <span class="n">data</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">selected</span><span
            class="p">]</span> <span class="o">=</span> <span class="n">noise</span>
    <span class="c1"># mask = np.zeros(len(test_nodes))</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span
            class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="n">mask</span><span class="p">[</span><span class="n">selected</span><span class="p">]</span> <span
            class="o">=</span> <span class="mi">1</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span
            class="n">tensor</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span><span
            class="o">.</span><span class="n">bool</span><span class="p">()</span><span class="o">.</span><span
            class="n">to</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span
            class="n">x</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">delta_feat</span><span class="p">,</span> <span class="n">mask</span></div>
</pre>
                        </div>

                    </div>
                </div>
                <footer>

                    <hr/>

                    <div role="contentinfo">
                        <p>&#169; Copyright 2024, Melody Group.</p>
                    </div>

                    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
                    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
                    provided by <a href="https://readthedocs.org">Read the Docs</a>.


                </footer>
            </div>
        </div>
    </section>
</div>
<script>
    jQuery(function () {
        SphinxRtdTheme.Navigation.enable(true);
    });
</script>

</body>
</html>